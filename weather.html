<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>城市天气预报</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    .weather-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .day-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 16px;
      width: 150px;
      text-align: center;
    }
    .day-box h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }
    .temp {
      font-size: 1.2rem;
      margin: 6px 0;
    }
    .temp.hot {
      color: #d43f3a;
    }
    .temp.cold {
      color: #337ab7;
    }
    .desc {
      font-size: 0.85rem;
      color: #666;
    }
    .weather-type {
      font-size: 0.95rem;
      font-weight: bold;
      color: #444;
      margin-bottom: 4px;
    }
    .weather-icon {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <h1 id="title">天气预报</h1>
  <div class="weather-container" id="weather"></div>

  <script>
    async function getCoordinates(city) {
      const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh`);
      const data = await res.json();
      if (!data.results || data.results.length === 0) throw new Error("找不到该城市");
      return {
        lat: data.results[0].latitude,
        lon: data.results[0].longitude,
        name: data.results[0].name
      };
    }

    async function getForecast(lat, lon, days) {
      const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max,weathercode&timezone=auto&forecast_days=${days}`);
      return await res.json();
    }

    function getWeatherDescription(code) {
      const map = {
        0: ["晴天", "☀️"],
        1: ["多云", "🌤"],
        2: ["部分多云", "⛅"],
        3: ["阴天", "☁️"],
        45: ["薄雾", "🌫"],
        48: ["雾霭", "🌫"],
        51: ["小毛毛雨", "🌦"],
        53: ["中毛毛雨", "🌧"],
        55: ["大毛毛雨", "🌧"],
        61: ["小雨", "🌧"],
        63: ["中雨", "🌧"],
        65: ["大雨", "🌧"],
        71: ["小雪", "🌨"],
        73: ["中雪", "❄️"],
        75: ["大雪", "❄️"],
        95: ["雷阵雨", "⛈"],
        96: ["雷阵雨伴小冰雹", "⛈"],
        99: ["雷阵雨伴大冰雹", "⛈"]
      };
      return map[code] || ["未知", "❓"];
    }

    async function init() {
      const params = new URLSearchParams(location.search);
      const city = params.get("city") || "Tokyo";
      const days = parseInt(params.get("days") || "3");

      try {
        const { lat, lon, name } = await getCoordinates(city);
        const forecast = await getForecast(lat, lon, days);

        document.getElementById("title").textContent = `${name} - ${days}天天气预报`;
        const container = document.getElementById("weather");
        const daily = forecast.daily;

        for (let i = 0; i < days; i++) {
          const date = daily.time[i];
          const max = daily.temperature_2m_max[i];
          const min = daily.temperature_2m_min[i];
          const rain = daily.precipitation_probability_max[i];
          const wind = daily.windspeed_10m_max[i];
          const weatherCode = daily.weathercode[i];
          const [weatherDesc, weatherIcon] = getWeatherDescription(weatherCode);

          const tempClass = max >= 30 ? "hot" : min <= 5 ? "cold" : "";

          const box = document.createElement("div");
          box.className = "day-box";
          box.innerHTML = `
            <h3>${date}</h3>
            <div class="weather-icon">${weatherIcon}</div>
            <div class="weather-type">${weatherDesc}</div>
            <div class="temp ${tempClass}">${min}℃ ~ ${max}℃</div>
            <div class="desc">降水概率：${rain}%</div>
            <div class="desc">最大风速：${wind} km/h</div>
          `;
          container.appendChild(box);
        }
      } catch (err) {
        document.getElementById("weather").textContent = "获取天气失败，请检查城市名或网络";
      }
    }

    init();
  </script>
</body>
</html>
