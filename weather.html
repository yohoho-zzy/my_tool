<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŸå¸‚å¤©æ°”é¢„æŠ¥</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    .weather-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .day-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 16px;
      width: 150px;
      text-align: center;
    }
    .day-box h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }
    .temp {
      font-size: 1.2rem;
      margin: 6px 0;
    }
    .temp.hot {
      color: #d43f3a;
    }
    .temp.cold {
      color: #337ab7;
    }
    .desc {
      font-size: 0.85rem;
      color: #666;
    }
    .weather-type {
      font-size: 0.95rem;
      font-weight: bold;
      color: #444;
      margin-bottom: 4px;
    }
    .weather-icon {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }
    .highlight {
      background-color: #ffefc2;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 id="title">å¤©æ°”é¢„æŠ¥</h1>
  <div class="weather-container" id="weather"></div>

  <script>
    async function getLocation() {
      try {
        return await new Promise((resolve, reject) => {
          navigator.geolocation.getCurrentPosition(
            pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
            () => resolve({ lat: 35.6764, lon: 139.6500, fallback: true }) // é»˜è®¤ä¸œäº¬
          );
        });
      } catch {
        return { lat: 35.6764, lon: 139.6500, fallback: true }; // é»˜è®¤ä¸œäº¬
      }
    }

    async function getCoordinates(city) {
      const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh`);
      const data = await res.json();
      if (!data.results || data.results.length === 0) throw new Error("æ‰¾ä¸åˆ°è¯¥åŸå¸‚");
      return {
        lat: data.results[0].latitude,
        lon: data.results[0].longitude,
        name: data.results[0].name
      };
    }

    function getWeatherDescription(code) {
      const map = {
        0: ["æ™´å¤©", "â˜€ï¸"], 1: ["å¤šäº‘", "ğŸŒ¤"], 2: ["éƒ¨åˆ†å¤šäº‘", "â›…"], 3: ["é˜´å¤©", "â˜ï¸"],
        45: ["è–„é›¾", "ğŸŒ«"], 48: ["é›¾éœ­", "ğŸŒ«"],
        51: ["å°æ¯›æ¯›é›¨", "ğŸŒ¦"], 53: ["ä¸­æ¯›æ¯›é›¨", "ğŸŒ§"], 55: ["å¤§æ¯›æ¯›é›¨", "ğŸŒ§"],
        61: ["å°é›¨", "ğŸŒ§"], 63: ["ä¸­é›¨", "ğŸŒ§"], 65: ["å¤§é›¨", "ğŸŒ§"],
        71: ["å°é›ª", "ğŸŒ¨"], 73: ["ä¸­é›ª", "â„ï¸"], 75: ["å¤§é›ª", "â„ï¸"],
        95: ["é›·é˜µé›¨", "â›ˆ"], 96: ["é›·é˜µé›¨ä¼´å°å†°é›¹", "â›ˆ"], 99: ["é›·é˜µé›¨ä¼´å¤§å†°é›¹", "â›ˆ"]
      };
      return map[code] || ["æœªçŸ¥", "â“"];
    }

    async function init() {
      const params = new URLSearchParams(location.search);
      const city = params.get("city");
      const days = parseInt(params.get("days") || "3");
      const container = document.getElementById("weather");
      const now = new Date();
      const currentHour = now.getHours();

      if (!city) {
        try {
          const loc = await getLocation();
          const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=temperature_2m,weathercode&timezone=auto`);
          const data = await res.json();
          document.getElementById("title").textContent = (loc.fallback ? "é»˜è®¤ä½ç½®ï¼ˆä¸œäº¬ï¼‰" : "å½“å‰ä½ç½®") + " - ä»Šæ—¥æ¯å°æ—¶å¤©æ°”";

          const hours = data.hourly.time;
          const temps = data.hourly.temperature_2m;
          const codes = data.hourly.weathercode;

          for (let i = 0; i < hours.length; i++) {
            const hourStr = hours[i].slice(11, 16);
            if (!hours[i].startsWith(now.toISOString().slice(0, 10))) continue;

            const box = document.createElement("div");
            box.className = "day-box" + (parseInt(hourStr.slice(0, 2)) === currentHour ? " highlight" : "");
            const [desc, icon] = getWeatherDescription(codes[i]);
            const tempClass = temps[i] >= 30 ? "hot" : temps[i] <= 5 ? "cold" : "";
            box.innerHTML = `
              <h3>${hourStr}</h3>
              <div class="weather-icon">${icon}</div>
              <div class="weather-type">${desc}</div>
              <div class="temp ${tempClass}">${temps[i]}â„ƒ</div>
            `;
            container.appendChild(box);
          }
        } catch (e) {
          container.textContent = "æ— æ³•è·å–å¤©æ°”æ•°æ®ã€‚";
        }
        return;
      }

      try {
        const { lat, lon, name } = await getCoordinates(city);
        const forecast = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max,weathercode&timezone=auto&forecast_days=${days}`)
          .then(res => res.json());

        document.getElementById("title").textContent = `${name} - ${days}å¤©å¤©æ°”é¢„æŠ¥`;
        const daily = forecast.daily;

        for (let i = 0; i < days; i++) {
          const date = daily.time[i];
          const max = daily.temperature_2m_max[i];
          const min = daily.temperature_2m_min[i];
          const rain = daily.precipitation_probability_max[i];
          const wind = daily.windspeed_10m_max[i];
          const weatherCode = daily.weathercode[i];
          const [weatherDesc, weatherIcon] = getWeatherDescription(weatherCode);

          const tempClass = max >= 30 ? "hot" : min <= 5 ? "cold" : "";

          const box = document.createElement("div");
          box.className = "day-box";
          box.innerHTML = `
            <h3>${date}</h3>
            <div class="weather-icon">${weatherIcon}</div>
            <div class="weather-type">${weatherDesc}</div>
            <div class="temp ${tempClass}">${min}â„ƒ ~ ${max}â„ƒ</div>
            <div class="desc">é™æ°´æ¦‚ç‡ï¼š${rain}%</div>
            <div class="desc">æœ€å¤§é£é€Ÿï¼š${wind} km/h</div>
          `;
          container.appendChild(box);
        }
      } catch (err) {
        container.textContent = "è·å–å¤©æ°”å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸå¸‚åæˆ–ç½‘ç»œ";
      }
    }

    init();
  </script>
</body>
</html>
