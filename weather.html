<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>åŸå¸‚å¤©æ°”é¢„æŠ¥</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      padding: 20px;
      background: #f5f5f5;
      color: #333;
    }
    h1 {
      text-align: center;
    }
    .weather-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: center;
    }
    .day-box {
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 16px;
      width: 150px;
      text-align: center;
    }
    .day-box h3 {
      margin: 0 0 8px;
      font-size: 1.1rem;
    }
    .temp {
      font-size: 1.2rem;
      margin: 6px 0;
    }
    .temp.hot {
      color: #d43f3a;
    }
    .temp.cold {
      color: #337ab7;
    }
    .desc {
      font-size: 0.85rem;
      color: #666;
    }
    .weather-type {
      font-size: 0.95rem;
      font-weight: bold;
      margin-bottom: 4px;
    }
    .weather-icon {
      font-size: 1.8rem;
      margin-bottom: 4px;
    }
    .highlight {
      background-color: #ffefc2;
      font-weight: bold;
    }
    .rainy .weather-type { color: #007bff; }
    .snowy .weather-type { color: #5bc0de; }
    .stormy .weather-type { color: #d9534f; }
    .foggy .weather-type { color: #999; }
  </style>
</head>
<body>
  <h1 id="title">å¤©æ°”é¢„æŠ¥</h1>
  <div class="weather-container" id="weather"></div>

  <script>
    function getWeatherDescription(code) {
      const map = {
        0: ["æ™´å¤©", "â˜€ï¸"],
        1: ["åŸºæœ¬æ™´æœ—", "ğŸŒ¤"],
        2: ["éƒ¨åˆ†å¤šäº‘", "â›…"],
        3: ["é˜´å¤©", "â˜ï¸"],
        45: ["è–„é›¾", "ğŸŒ«"],
        48: ["é›¾éœ­ï¼ˆç»“å†°ï¼‰", "ğŸŒ«"],
        51: ["è½»å¾®æ¯›æ¯›é›¨", "ğŸŒ¦"],
        53: ["ä¸­ç­‰æ¯›æ¯›é›¨", "ğŸŒ¦"],
        55: ["æµ“å¯†æ¯›æ¯›é›¨", "ğŸŒ§"],
        56: ["è½»å¾®å†»æ¯›æ¯›é›¨", "ğŸŒ§"],
        57: ["æµ“å¯†å†»æ¯›æ¯›é›¨", "ğŸŒ§"],
        61: ["å°é›¨", "ğŸŒ§"],
        63: ["ä¸­é›¨", "ğŸŒ§"],
        65: ["å¤§é›¨", "ğŸŒ§"],
        66: ["å°å†»é›¨", "ğŸŒ§"],
        67: ["å¤§å†»é›¨", "ğŸŒ§"],
        71: ["å°é›ª", "ğŸŒ¨"],
        73: ["ä¸­é›ª", "ğŸŒ¨"],
        75: ["å¤§é›ª", "â„ï¸"],
        77: ["éœ°/é›ªç²’", "â„ï¸"],
        80: ["è½»å¾®é˜µé›¨", "ğŸŒ¦"],
        81: ["ä¸­ç­‰é˜µé›¨", "ğŸŒ§"],
        82: ["å¼ºçƒˆé˜µé›¨", "ğŸŒ§"],
        85: ["å°é˜µé›ª", "ğŸŒ¨"],
        86: ["å¤§é˜µé›ª", "â„ï¸"],
        95: ["é›·é›¨", "â›ˆ"],
        96: ["é›·é›¨ä¼´å°å†°é›¹", "â›ˆ"],
        99: ["é›·é›¨ä¼´å¤§å†°é›¹", "â›ˆ"]
      };
      return map[code] || ["æœªçŸ¥", "â“"];
    }

    function getWindIconAndLevel(speed) {
      if (speed < 2) return ["ğŸƒ", "æ— é£"];
      if (speed < 6) return ["ğŸŒ¬", "å¾®é£"];
      if (speed < 12) return ["ğŸŒ¬", "è½»é£"];
      if (speed < 20) return ["ğŸŒ¬", "å’Œé£"];
      if (speed < 29) return ["ğŸ’¨", "å¼ºé£"];
      if (speed < 39) return ["ğŸ’¨", "ç–¾é£"];
      return ["ğŸŒª", "çƒˆé£"];
    }

    function getUvLevelIcon(uv) {
      if (uv < 3) return ["ğŸŸ¢ ä½", "green"];
      if (uv < 6) return ["ğŸŸ¡ ä¸­", "orange"];
      if (uv < 8) return ["ğŸŸ  é«˜", "orangered"];
      if (uv < 11) return ["ğŸ”´ å¾ˆé«˜", "red"];
      return ["ğŸŸ£ æé«˜", "purple"];
    }

    function isRainy(code) {
      return [51, 53, 55, 61, 63, 65, 66, 67, 80, 81, 82].includes(code);
    }

    function isSnowy(code) {
      return [71, 73, 75, 77, 85, 86].includes(code);
    }

    function isCloudy(code) {
      return [1, 2, 3, 45, 48].includes(code);
    }

    async function getLocation() {
      try {
        return await new Promise((resolve) => {
          navigator.geolocation.getCurrentPosition(
            pos => resolve({ lat: pos.coords.latitude, lon: pos.coords.longitude }),
            () => resolve({ lat: 35.6764, lon: 139.6500, fallback: true })
          );
        });
      } catch {
        return { lat: 35.6764, lon: 139.6500, fallback: true };
      }
    }

    async function getCoordinates(city) {
      const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1&language=zh`);
      const data = await res.json();
      if (!data.results || data.results.length === 0) throw new Error("æ‰¾ä¸åˆ°è¯¥åŸå¸‚");
      return {
        lat: data.results[0].latitude,
        lon: data.results[0].longitude,
        name: data.results[0].name
      };
    }

    async function init() {
      const params = new URLSearchParams(location.search);
      const city = params.get("city");
      const days = parseInt(params.get("days") || "3");
      const container = document.getElementById("weather");
      const now = new Date();
      const currentHour = now.getHours();

      if (!city) {
        try {
          const loc = await getLocation();
          const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${loc.lat}&longitude=${loc.lon}&hourly=temperature_2m,weathercode,precipitation,cloudcover,uv_index,visibility,windspeed_10m&timezone=auto`);
          const data = await res.json();
          document.getElementById("title").textContent = (loc.fallback ? "é»˜è®¤ä½ç½®ï¼ˆä¸œäº¬ï¼‰" : "å½“å‰ä½ç½®") + " - ä»Šæ—¥æ¯å°æ—¶å¤©æ°”";

          const hours = data.hourly.time;
          const temps = data.hourly.temperature_2m;
          const codes = data.hourly.weathercode;
          const precipitation = data.hourly.precipitation;
          const cloudcover = data.hourly.cloudcover;
          const uvindex = data.hourly.uv_index;
          const visibility = data.hourly.visibility;
          const windspeed = data.hourly.windspeed_10m;

          for (let i = 0; i < hours.length; i++) {
            const hourStr = hours[i].slice(11, 16);
            if (!hours[i].startsWith(now.toISOString().slice(0, 10))) continue;

            const code = codes[i];
            const [desc, icon] = getWeatherDescription(code);
            const tempClass = temps[i] >= 30 ? "hot" : temps[i] <= 5 ? "cold" : "";

            const [windIcon, windLevel] = getWindIconAndLevel(windspeed[i]);
            let weatherClass = "";
            if (isRainy(code)) weatherClass = "rainy";
            else if (isSnowy(code)) weatherClass = "snowy";
            else if ([95, 96, 99].includes(code)) weatherClass = "stormy";
            else if ([45, 48].includes(code)) weatherClass = "foggy";

            let extra = `<div class="desc">${windIcon} é£é€Ÿï¼š${windspeed[i]} km/hï¼ˆ${windLevel}ï¼‰</div>`;
            if (isRainy(code)) {
              extra += `<div class="desc">ğŸŒ§ é™æ°´é‡ï¼š${precipitation[i]} mm</div>`;
            }
            if (isSnowy(code)) {
              extra += `<div class="desc">ğŸŒ¨ é™é›ªé‡ï¼š${precipitation[i]} mm</div>`;
            }
            if (isCloudy(code)) {
              extra += `<div class="desc">â˜ï¸ äº‘é‡ï¼š${cloudcover[i]}%</div>`;
            }
            if (uvindex[i] != null) {
              const [uvDesc, uvColor] = getUvLevelIcon(uvindex[i]);
              extra += `<div class="desc" style="color:${uvColor}">â˜€ï¸ UVï¼š${uvindex[i]}ï¼ˆ${uvDesc}ï¼‰</div>`;
            }
            if (visibility[i] != null) {
              extra += `<div class="desc">ğŸ‘ èƒ½è§åº¦ï¼š${visibility[i]} m</div>`;
            }

            const box = document.createElement("div");
            box.className = `day-box${parseInt(hourStr.slice(0, 2)) === currentHour ? " highlight" : ""} ${weatherClass}`;
            box.innerHTML = `
              <h3>${hourStr}</h3>
              <div class="weather-icon">${icon}</div>
              <div class="weather-type">${desc}</div>
              <div class="temp ${tempClass}">${temps[i]}â„ƒ</div>
              ${extra}
            `;
            container.appendChild(box);
          }
        } catch (e) {
          container.textContent = "æ— æ³•è·å–å¤©æ°”æ•°æ®ã€‚";
        }
        return;
      }

      try {
        const { lat, lon, name } = await getCoordinates(city);
        const forecast = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&daily=temperature_2m_max,temperature_2m_min,precipitation_probability_max,windspeed_10m_max,weathercode&timezone=auto&forecast_days=${days}`)
          .then(res => res.json());

        document.getElementById("title").textContent = `${name} - ${days}å¤©å¤©æ°”é¢„æŠ¥`;
        const daily = forecast.daily;

        for (let i = 0; i < days; i++) {
          const date = daily.time[i];
          const max = daily.temperature_2m_max[i];
          const min = daily.temperature_2m_min[i];
          const rain = daily.precipitation_probability_max[i];
          const wind = daily.windspeed_10m_max[i];
          const weatherCode = daily.weathercode[i];
          const [weatherDesc, weatherIcon] = getWeatherDescription(weatherCode);

          const tempClass = max >= 30 ? "hot" : min <= 5 ? "cold" : "";

          const box = document.createElement("div");
          box.className = "day-box";
          box.innerHTML = `
            <h3>${date}</h3>
            <div class="weather-icon">${weatherIcon}</div>
            <div class="weather-type">${weatherDesc}</div>
            <div class="temp ${tempClass}">${min}â„ƒ ~ ${max}â„ƒ</div>
            <div class="desc">ğŸŒ§ é™æ°´æ¦‚ç‡ï¼š${rain}%</div>
            <div class="desc">ğŸ’¨ æœ€å¤§é£é€Ÿï¼š${wind} km/h</div>
          `;
          container.appendChild(box);
        }
      } catch (err) {
        container.textContent = "è·å–å¤©æ°”å¤±è´¥ï¼Œè¯·æ£€æŸ¥åŸå¸‚åæˆ–ç½‘ç»œ";
      }
    }

    init();
  </script>
</body>
</html>
